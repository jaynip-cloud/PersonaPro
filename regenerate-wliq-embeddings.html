<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Regenerate WLIQ Meeting Embeddings</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .info { background: #e3f2fd; border-left: 4px solid #2196F3; }
    .success { background: #e8f5e9; border-left: 4px solid #4CAF50; }
    .error { background: #ffebee; border-left: 4px solid #f44336; }
    .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 0;
    }
    button:hover { background: #1976D2; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
    }
    .log-entry {
      margin: 8px 0;
      padding: 8px;
      background: #fafafa;
      border-left: 3px solid #ddd;
      font-family: monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ðŸ”„ Regenerate WLIQ Meeting Embeddings</h1>

  <div class="status info">
    <h3>What this does:</h3>
    <ul>
      <li>Deletes old embeddings (2 large chunks of 5934 and 3429 chars)</li>
      <li>Regenerates embeddings with proper chunking (600 chars per chunk)</li>
      <li>Creates many smaller, more focused chunks for better semantic search</li>
    </ul>
  </div>

  <div class="status warning">
    <strong>Recording ID:</strong> <code>970c2056-397b-4c3f-bbfb-ada041a91747</code><br>
    <strong>Recording Title:</strong> WLIQ and Brilliant Media AK<br>
    <strong>Client:</strong> High Reason
  </div>

  <button id="regenerateBtn" onclick="regenerateEmbeddings()">Start Regeneration</button>

  <div id="output"></div>

  <script>
    const SUPABASE_URL = 'https://dxfagynvuqjdzbgroivu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4ZmFneW52dXFqZHpiZ3JvaXZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5MDU2NzgsImV4cCI6MjA3NzQ4MTY3OH0.z9jxvkliQZN59mM0RCkbMnfDL-k4R13N5ezE6JB2Aig';
    const RECORDING_ID = '970c2056-397b-4c3f-bbfb-ada041a91747';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const output = document.getElementById('output');
    const btn = document.getElementById('regenerateBtn');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      output.appendChild(div);
      console.log(message);
    }

    function logEntry(message) {
      const div = document.createElement('div');
      div.className = 'log-entry';
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      output.appendChild(div);
    }

    async function regenerateEmbeddings() {
      btn.disabled = true;
      output.innerHTML = '';

      try {
        log('<strong>Step 1:</strong> Authenticating...', 'info');

        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          log('<strong>Error:</strong> Not logged in. Please log in to the application first.', 'error');
          btn.disabled = false;
          return;
        }

        logEntry('Authenticated as: ' + session.user.email);

        log('<strong>Step 2:</strong> Deleting old embeddings...', 'info');

        const { error: deleteError } = await supabase
          .from('fathom_embeddings')
          .delete()
          .eq('recording_id', RECORDING_ID);

        if (deleteError) {
          log('<strong>Warning:</strong> Error deleting old embeddings: ' + deleteError.message, 'warning');
        } else {
          logEntry('Old embeddings deleted successfully');
        }

        log('<strong>Step 3:</strong> Resetting recording status...', 'info');

        const { error: updateError } = await supabase
          .from('fathom_recordings')
          .update({ embeddings_generated: false })
          .eq('id', RECORDING_ID);

        if (updateError) {
          log('<strong>Error:</strong> Failed to reset recording: ' + updateError.message, 'error');
          btn.disabled = false;
          return;
        }

        logEntry('Recording status reset');

        log('<strong>Step 4:</strong> Calling process-fathom-embeddings edge function...', 'info');
        logEntry('This may take 30-60 seconds...');

        const apiUrl = `${SUPABASE_URL}/functions/v1/process-fathom-embeddings`;

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${session.access_token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            recording_id: RECORDING_ID,
            force_regenerate: true
          })
        });

        const result = await response.json();

        if (!response.ok) {
          log(`<strong>Error:</strong> ${result.error || 'Unknown error'}`, 'error');
          log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'error');
          btn.disabled = false;
          return;
        }

        log('<strong>âœ… Success!</strong> Embeddings regenerated', 'success');
        log(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'success');

        log('<strong>Step 5:</strong> Verifying new embeddings...', 'info');

        const { data: embeddings, error: checkError } = await supabase
          .from('fathom_embeddings')
          .select('id, chunk_index, chunk_text')
          .eq('recording_id', RECORDING_ID)
          .order('chunk_index');

        if (checkError) {
          log('<strong>Error:</strong> Failed to verify: ' + checkError.message, 'error');
        } else {
          log(`<strong>Verification Complete:</strong> Found ${embeddings.length} new chunks`, 'success');

          const chunkSizes = embeddings.map(e => e.chunk_text.length);
          const avgSize = Math.round(chunkSizes.reduce((a, b) => a + b, 0) / chunkSizes.length);
          const minSize = Math.min(...chunkSizes);
          const maxSize = Math.max(...chunkSizes);

          log(`
            <strong>Chunk Statistics:</strong><br>
            â€¢ Total chunks: ${embeddings.length}<br>
            â€¢ Average size: ${avgSize} characters<br>
            â€¢ Min size: ${minSize} characters<br>
            â€¢ Max size: ${maxSize} characters<br>
            <br>
            <em>These smaller chunks should work much better for semantic search!</em>
          `, 'success');

          log(`
            <strong>Next Steps:</strong><br>
            1. Go to the High Reason client page<br>
            2. Open the Intelligence Agent<br>
            3. Try queries like:<br>
            &nbsp;&nbsp;â€¢ "What was discussed in the WLIQ meeting?"<br>
            &nbsp;&nbsp;â€¢ "Tell me about Jessica Wagner and Alay Naik"<br>
            &nbsp;&nbsp;â€¢ "What issues did Brilliant Media mention?"<br>
            &nbsp;&nbsp;â€¢ "Who attended the transition meeting?"
          `, 'info');
        }

      } catch (error) {
        log('<strong>Error:</strong> ' + error.message, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
      }
    }

    log('Ready to regenerate embeddings. Click the button above to start.', 'info');
  </script>
</body>
</html>
